---
title: "QC-ART Primer"
author: "Bryan Stanfill, Lisa Bramer, Allison Thompson, Bobbie-Jo Webb-Robertson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction
This document shows by example how to use the package `QCART` to track the quality of mass spectrometry experiments in near real time.  This is done using publicly available data that has previously been analyzed by [Amidan et al. (2014)](http://pubs.acs.org/doi/abs/10.1021/pr401143e).

# Data

The Amidan et al. data is built into the package and is loaded into your environment with the following (the `QCART` package is also loaded here in case you haven't done that yet).
```{r load}
library(QCART)
data("amidan_et_al")
```

```{r lubridate, include=FALSE}
library(lubridate)
amidan$Acq_Time_Start2 <- mdy_hm(amidan$Acq_Time_Start)
chosen_inst <- "VOrbiETD04"
```
Now there should be a data frame called `amidan` loaded into your environment.  In short, the `amdian` data frame consists of `r ncol(amidan)` variables measured on `r nrow(amidan)` LC-MS experiments.  The data were collected using `r length(unique(amidan$Instument))` different instruments over the course of `r round_date(min(amidan$Acq_Time_Start2),unit='day')` to `r round_date(max(amidan$Acq_Time_Start2),unit='day')`.

# QC-ART

To apply QC-ART to the `amidan` data we need to separate the data into instruments.  For this example we consider the instrument called `r chosen_inst`, which consists of `r length(which(amidan$Instrument==chosen_inst))`.  To do this we use the package `dplyr`.

```{r subset,message=FALSE}
library(dplyr)
chosen_inst <- "VOrbiETD04"
vorb_04 <- filter(amidan,Instrument==chosen_inst)
```

To get a feel for the data, let's plot a few of the variables we know to be of interest over the course of experiments analyzed with the `r chosen_inst` instrument.  We make plots with the `ggplot2` package and use the `lubridate` to make our lives easier when dealing with date information.

```{r plot,messages=FALSE,warning=FALSE,fig.subcap=c("P 2C","MS1_Count"),fig.width=4,fig.height=4}
library(ggplot2)
library(lubridate)
vorb_04$Acq_Time_Start <- mdy_hm(vorb_04$Acq_Time_Start)
qplot(Acq_Time_Start,P_2C,data=vorb_04,xlab="Date")
qplot(Acq_Time_Start,MS1_Count,data=vorb_04,xlab="Date")
```


To apply QC-ART, the variables used to compute QC-ART scores needs to be chosen.  Based on the results of the initial analysis of these data (by Amidan et al.), we chose the following variables.

```{r vars}
chosen_vars <- c("P_2C","MS1_Count","MS2_Count","MS1_2B","MS2_1","MS2_2","MS2_3","MS2_4A","MS2_4B","RT_MS_Q1","RT_MS_Q4","RT_MSMS_Q1","RT_MSMS_Q4","XIC_WideFrac")
```

Next we need to select a baseline set against which all future experiments will be compared.  Assume for now that the experiments run early in the study are of good quality and we want to determine if the later runs are of the same quality.  Thus the first 10 instrument runs serve as the baseline and all further experiments are compared against those 10.  With that, we can compute QC-ART scores and plot them over time.

```{r run_qcart}
vorb_04 <- arrange(vorb_04,Acq_Time_Start)
bline_ob <- 1:10
vorb_04$Baseline <- FALSE
vorb_04$Baseline[bline_ob] <- TRUE
vorb_04$QC_Art <- qcart(all_data = vorb_04, baseline = bline_ob, variables = chosen_vars)
qplot(Acq_Time_Start,QC_Art,data=vorb_04,colour=Baseline)+xlab("Date")+ylab("QC-ART Score")
```

Once scores are computed, a threshold value needs to be determined in order to identify which samples may need to be reanalyzed.  The `compute_threshold` function takes the QC-ART scores (computed by `qcart`), baseline indicators and time-stamps then returns a `data.frame` that contains the cores, time-stamps and threshold values.  

```{r sthresh}
qcart_threshold <- compute_threshold(scores = vorb_04$QC_Art, baseline = vorb_04$Baseline, time_stamps = vorb_04$Acq_Time_Start, type='static')

qplot(Time_Stamp,Scores,data=qcart_threshold,colour=Baseline)+xlab("Date")+ylab("QC-ART Score")+
  geom_line(aes(Time_Stamp,Static_Threshold),colour=1)
```

The column `Static_Threshold` contains the static threshold value corresponding to each QC-ART score.  Internally, 'static threshold value may `compute_threshold` fits to models to the QC-ART scores: a simple log-linear regression model (SLR) where the time since the first instrument run is used as the only covariate, and a single mean model.  If the SLR model accounts for a statistically significant amount of the variability in the baseline scores (at the 0.05 level), then that model is used.  Otherwise, the single mean model is used.  The former will return threshold values that differ for each QC-ART score depending upon the time since the first instrument run, while the latter will return a single value cutoff value for all QC-ART scores.


